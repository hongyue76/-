<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»çº¿æŒ‡ç¤ºå™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .status-display {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f0f0f0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #1976d2;
            color: white;
        }
        button:hover {
            background: #1565c0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ“¡ ç¦»çº¿æŒ‡ç¤ºå™¨æµ‹è¯•</h1>
        
        <div class="status-display" id="statusDisplay">
            <h3>çŠ¶æ€æ£€æŸ¥ä¸­...</h3>
        </div>
        
        <div>
            <button onclick="testNetworkProperties()">æµ‹è¯•ç½‘ç»œå±æ€§</button>
            <button onclick="simulateOffline()">æ¨¡æ‹Ÿç¦»çº¿</button>
            <button onclick="simulateOnline()">æ¨¡æ‹Ÿåœ¨çº¿</button>
            <button onclick="checkServerReachable()">æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</button>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>æµ‹è¯•ç»“æœ:</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸVueçš„å“åº”å¼ç³»ç»Ÿ
        function createReactive(obj) {
            return new Proxy(obj, {
                get(target, prop) {
                    return target[prop];
                },
                set(target, prop, value) {
                    target[prop] = value;
                    updateDisplay();
                    return true;
                }
            });
        }

        // ç½‘ç»œçŠ¶æ€å¯¹è±¡
        const networkStatus = createReactive({
            online: navigator.onLine,
            type: 'unknown',
            downlink: 0,
            rtt: 0,
            saveData: false,
            serverReachable: true
        });

        const isOnline = createReactive({ value: navigator.onLine });

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const display = document.getElementById('statusDisplay');
            const results = document.getElementById('testResults');
            
            display.innerHTML = `
                <h3>å½“å‰ç½‘ç»œçŠ¶æ€</h3>
                <p><strong>åœ¨çº¿çŠ¶æ€:</strong> ${isOnline.value ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'}</p>
                <p><strong>æœåŠ¡å™¨å¯è¾¾:</strong> ${(networkStatus.serverReachable ?? 'æœªå®šä¹‰') ? 'ğŸŸ¢ æ­£å¸¸' : 'ğŸ”´ å¼‚å¸¸'}</p>
                <p><strong>è¿æ¥ç±»å‹:</strong> ${networkStatus.type}</p>
                <p><strong>ä¸‹è¡Œé€Ÿåº¦:</strong> ${networkStatus.downlink} Mbps</p>
                <p><strong>å»¶è¿Ÿ:</strong> ${networkStatus.rtt} ms</p>
            `;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            const hasError = !isOnline.value || !(networkStatus.serverReachable ?? true);
            display.className = `status-display ${hasError ? 'error' : 'success'}`;
        }

        // æµ‹è¯•ç½‘ç»œå±æ€§è®¿é—®
        function testNetworkProperties() {
            const results = document.getElementById('testResults');
            let testResults = '<h4>å±æ€§è®¿é—®æµ‹è¯•:</h4>';
            
            try {
                // æµ‹è¯•å®‰å…¨è®¿é—®
                const serverReachableSafe = networkStatus.serverReachable ?? true;
                testResults += `<p>âœ… å®‰å…¨è®¿é—® serverReachable: ${serverReachableSafe}</p>`;
                
                // æµ‹è¯•ç›´æ¥è®¿é—®
                const serverReachableDirect = networkStatus.serverReachable;
                testResults += `<p>âœ… ç›´æ¥è®¿é—® serverReachable: ${serverReachableDirect}</p>`;
                
                // æµ‹è¯•è®¡ç®—å±æ€§
                const isFullyOnline = isOnline.value && (networkStatus.serverReachable ?? true);
                testResults += `<p>âœ… å®Œå…¨åœ¨çº¿çŠ¶æ€: ${isFullyOnline}</p>`;
                
                results.innerHTML = testResults;
                
            } catch (error) {
                testResults += `<p class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                results.innerHTML = testResults;
            }
        }

        // æ¨¡æ‹Ÿç¦»çº¿
        function simulateOffline() {
            isOnline.value = false;
            networkStatus.online = false;
            addTestResult('æ¨¡æ‹Ÿç¦»çº¿çŠ¶æ€');
        }

        // æ¨¡æ‹Ÿåœ¨çº¿
        function simulateOnline() {
            isOnline.value = true;
            networkStatus.online = true;
            addTestResult('æ¨¡æ‹Ÿåœ¨çº¿çŠ¶æ€');
        }

        // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
        async function checkServerReachable() {
            try {
                const response = await fetch('http://localhost:8001/health', { 
                    method: 'GET',
                    timeout: 5000
                });
                
                networkStatus.serverReachable = response.ok;
                addTestResult(`æœåŠ¡å™¨è¿æ¥æ£€æŸ¥: ${response.ok ? 'æˆåŠŸ' : 'å¤±è´¥'} (${response.status})`);
            } catch (error) {
                networkStatus.serverReachable = false;
                addTestResult(`æœåŠ¡å™¨è¿æ¥æ£€æŸ¥: å¤±è´¥ (${error.message})`);
            }
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message) {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<p>[${timestamp}] ${message}</p>`;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            addTestResult('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            
            // ç›‘å¬çœŸå®çš„ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', () => {
                isOnline.value = true;
                networkStatus.online = true;
                addTestResult('æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥æ¢å¤');
            });
            
            window.addEventListener('offline', () => {
                isOnline.value = false;
                networkStatus.online = false;
                addTestResult('æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥æ–­å¼€');
            });
        });
    </script>
</body>
</html>