<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶åŒæ­¥æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background-color: #52c41a; }
        .connecting { background-color: #faad14; }
        .disconnected { background-color: #ff4d4f; }
        .message {
            background: #f0f2f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1890ff;
        }
        .input-group {
            margin: 15px 0;
        }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
        }
        button {
            background: #1890ff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #40a9ff;
        }
        .log {
            height: 300px;
            overflow-y: auto;
            background: #000;
            color: #00ff00;
            padding: 15px;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
        }
        .room-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .room-tag {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
        }
        .room-tag button {
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            margin-left: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å®æ—¶åŒæ­¥åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="message">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div>
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
            <div>åœ¨çº¿ç”¨æˆ·: <span id="onlineUsers">0</span></div>
            <div>å½“å‰æˆ¿é—´: <span id="currentRooms">æ— </span></div>
        </div>

        <!-- è®¤è¯åŒºåŸŸ -->
        <div class="message">
            <h3>ç”¨æˆ·è®¤è¯</h3>
            <div class="input-group">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="testuser">
                <input type="password" id="password" placeholder="å¯†ç " value="testpass123">
                <button onclick="login()">ç™»å½•</button>
                <button onclick="logout()">ç™»å‡º</button>
            </div>
            <div>Token: <span id="tokenDisplay">æœªç™»å½•</span></div>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div class="message">
            <h3>æˆ¿é—´ç®¡ç†</h3>
            <div class="input-group">
                <input type="text" id="roomName" placeholder="æˆ¿é—´åç§°">
                <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
                <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
            </div>
            <div class="room-list" id="roomList"></div>
        </div>

        <!-- æ¶ˆæ¯å‘é€ -->
        <div class="message">
            <h3>å‘é€æ¶ˆæ¯</h3>
            <div class="input-group">
                <select id="messageType">
                    <option value="sync_request">åŒæ­¥è¯·æ±‚</option>
                    <option value="chat_message">èŠå¤©æ¶ˆæ¯</option>
                    <option value="todo_update">å¾…åŠæ›´æ–°</option>
                </select>
                <input type="text" id="messageContent" placeholder="æ¶ˆæ¯å†…å®¹">
                <input type="text" id="roomId" placeholder="æˆ¿é—´ID (å¯é€‰)">
                <button onclick="sendMessage()">å‘é€</button>
            </div>
        </div>

        <!-- æ—¥å¿—æ˜¾ç¤º -->
        <div class="message">
            <h3>å®æ—¶æ—¥å¿—</h3>
            <div class="log" id="logOutput"></div>
            <button onclick="clearLog()" style="margin-top: 10px;">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let socket = null;
        let token = '';
        let currentRooms = new Set();
        let isConnected = false;

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = message;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // ç™»å½•
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                addLog('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:8001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.access_token;
                    document.getElementById('tokenDisplay').textContent = token.substring(0, 20) + '...';
                    addLog('ç™»å½•æˆåŠŸ', 'success');
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    connectWebSocket();
                } else {
                    addLog(`ç™»å½•å¤±è´¥: ${data.detail}`, 'error');
                }
            } catch (error) {
                addLog(`ç™»å½•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // ç™»å‡º
        function logout() {
            if (socket) {
                socket.close();
            }
            token = '';
            currentRooms.clear();
            isConnected = false;
            document.getElementById('tokenDisplay').textContent = 'æœªç™»å½•';
            updateStatus('disconnected', 'æœªè¿æ¥');
            updateRoomList();
            addLog('å·²ç™»å‡º', 'info');
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            if (!token) {
                addLog('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const roomsParam = currentRooms.size > 0 ? `&rooms=${Array.from(currentRooms).join(',')}` : '';
            const wsUrl = `ws://localhost:8001/api/ws/sync?token=${token}${roomsParam}`;
            
            updateStatus('connecting', 'è¿æ¥ä¸­...');
            addLog(`æ­£åœ¨è¿æ¥åˆ°: ${wsUrl}`);

            socket = new WebSocket(wsUrl);

            socket.onopen = function(event) {
                isConnected = true;
                updateStatus('connected', 'å·²è¿æ¥');
                addLog('WebSocketè¿æ¥å·²å»ºç«‹', 'success');
            };

            socket.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    addLog(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message, null, 2)}`);
                    
                    // å¤„ç†ç‰¹å®šç±»å‹çš„æ¶ˆæ¯
                    switch (message.type) {
                        case 'connection_confirmed':
                            document.getElementById('onlineUsers').textContent = message.online_users || 0;
                            updateRoomList();
                            break;
                        case 'sync_update':
                            addLog(`åŒæ­¥æ›´æ–°æ¥è‡ªç”¨æˆ· ${message.sender_id}`, 'info');
                            break;
                        case 'room_joined':
                            if (message.success) {
                                currentRooms.add(message.room_id);
                                updateRoomList();
                            }
                            break;
                        case 'room_left':
                            if (message.success) {
                                currentRooms.delete(message.room_id);
                                updateRoomList();
                            }
                            break;
                    }
                } catch (error) {
                    addLog(`è§£ææ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                }
            };

            socket.onclose = function(event) {
                isConnected = false;
                updateStatus('disconnected', 'è¿æ¥å·²æ–­å¼€');
                addLog(`è¿æ¥å…³é—­: ${event.code} - ${event.reason}`, 'warning');
            };

            socket.onerror = function(error) {
                addLog(`WebSocketé”™è¯¯: ${error.message}`, 'error');
            };
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLog('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const messageType = document.getElementById('messageType').value;
            const content = document.getElementById('messageContent').value;
            const roomId = document.getElementById('roomId').value;

            if (!content) {
                addLog('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            const message = {
                type: messageType,
                data: {
                    content: content,
                    timestamp: new Date().toISOString()
                }
            };

            if (roomId) {
                message.room_id = roomId;
            }

            socket.send(JSON.stringify(message));
            addLog(`å‘é€æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
            document.getElementById('messageContent').value = '';
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomName = document.getElementById('roomName').value;
            if (!roomName) {
                addLog('è¯·è¾“å…¥æˆ¿é—´åç§°', 'error');
                return;
            }

            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLog('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const message = {
                type: 'join_room',
                room_id: roomName
            };

            socket.send(JSON.stringify(message));
            addLog(`è¯·æ±‚åŠ å…¥æˆ¿é—´: ${roomName}`);
        }

        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            const roomName = document.getElementById('roomName').value;
            if (!roomName) {
                addLog('è¯·è¾“å…¥æˆ¿é—´åç§°', 'error');
                return;
            }

            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLog('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const message = {
                type: 'leave_room',
                room_id: roomName
            };

            socket.send(JSON.stringify(message));
            addLog(`è¯·æ±‚ç¦»å¼€æˆ¿é—´: ${roomName}`);
        }

        // æ›´æ–°æˆ¿é—´åˆ—è¡¨æ˜¾ç¤º
        function updateRoomList() {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';
            
            currentRooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-tag';
                roomElement.innerHTML = `
                    ${room}
                    <button onclick="leaveSpecificRoom('${room}')">Ã—</button>
                `;
                roomList.appendChild(roomElement);
            });
            
            document.getElementById('currentRooms').textContent = 
                currentRooms.size > 0 ? Array.from(currentRooms).join(', ') : 'æ— ';
        }

        // ç¦»å¼€ç‰¹å®šæˆ¿é—´
        function leaveSpecificRoom(roomId) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLog('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const message = {
                type: 'leave_room',
                room_id: roomId
            };

            socket.send(JSON.stringify(message));
            addLog(`è¯·æ±‚ç¦»å¼€æˆ¿é—´: ${roomId}`);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            addLog('å®æ—¶åŒæ­¥æµ‹è¯•é¡µé¢å·²åŠ è½½');
            addLog('è¯·å…ˆç™»å½•ä»¥å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>