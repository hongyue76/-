<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section-title {
            color: #1890ff;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #1890ff;
        }
        .endpoint {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1890ff;
        }
        .method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .get { background-color: #61affe; }
        .post { background-color: #49cc90; }
        .put { background-color: #fca130; }
        .delete { background-color: #f93e3e; }
        input, button, select, textarea {
            padding: 10px;
            margin: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #1890ff;
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }
        button:hover {
            background: #40a9ff;
        }
        .response {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .auth-section {
            background: #e6f7ff;
            border-color: #91d5ff;
        }
        .test-btn {
            background: #52c41a;
        }
        .test-btn:hover {
            background: #73d13d;
        }
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffccc7;
        }
        .success {
            color: #52c41a;
            background: #f6ffed;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #b7eb8f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¾…åŠäº‹é¡¹APIæµ‹è¯•å·¥å…·</h1>
        <p>æœ¬åœ°APIæ–‡æ¡£æ›¿ä»£æ–¹æ¡ˆï¼Œæ— éœ€å¤–éƒ¨CDNä¾èµ–</p>

        <!-- è®¤è¯åŒºåŸŸ -->
        <div class="section auth-section">
            <h2 class="section-title">ğŸ”’ ç”¨æˆ·è®¤è¯</h2>
            <div>
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
                <input type="password" id="password" placeholder="å¯†ç " value="admin123">
                <button onclick="login()">ç™»å½•è·å–Token</button>
                <button onclick="register()">æ³¨å†Œæ–°ç”¨æˆ·</button>
            </div>
            <div style="margin-top: 15px;">
                <strong>å½“å‰Token:</strong> <span id="currentToken">æœªç™»å½•</span>
            </div>
        </div>

        <!-- ç”¨æˆ·ç›¸å…³API -->
        <div class="section">
            <h2 class="section-title">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h2>
            
            <div class="endpoint">
                <span class="method get">GET</span>
                <strong>/api/users/me</strong> - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                <br><button class="test-btn" onclick="getCurrentUser()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method put">PUT</span>
                <strong>/api/users/me</strong> - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                <br>
                <textarea id="updateUserData" placeholder='{"email": "new@example.com", "full_name": "æ–°å§“å"}' rows="3" cols="50"></textarea>
                <br><button class="test-btn" onclick="updateUser()">æµ‹è¯•</button>
            </div>
        </div>

        <!-- å¾…åŠäº‹é¡¹API -->
        <div class="section">
            <h2 class="section-title">ğŸ“‹ å¾…åŠäº‹é¡¹</h2>
            
            <div class="endpoint">
                <span class="method get">GET</span>
                <strong>/api/todos/</strong> - è·å–å¾…åŠäº‹é¡¹åˆ—è¡¨
                <br>
                <input type="text" id="todoSkip" placeholder="skip (é»˜è®¤0)" value="0">
                <input type="text" id="todoLimit" placeholder="limit (é»˜è®¤100)" value="100">
                <button class="test-btn" onclick="getTodos()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method post">POST</span>
                <strong>/api/todos/</strong> - åˆ›å»ºå¾…åŠäº‹é¡¹
                <br>
                <textarea id="createTodoData" placeholder='{"title": "æµ‹è¯•ä»»åŠ¡", "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡", "priority": "high"}' rows="4" cols="50"></textarea>
                <br><button class="test-btn" onclick="createTodo()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method get">GET</span>
                <strong>/api/todos/{id}</strong> - è·å–ç‰¹å®šå¾…åŠäº‹é¡¹
                <br>
                <input type="text" id="getTodoId" placeholder="å¾…åŠäº‹é¡¹ID">
                <button class="test-btn" onclick="getTodoById()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method put">PUT</span>
                <strong>/api/todos/{id}</strong> - æ›´æ–°å¾…åŠäº‹é¡¹
                <br>
                <input type="text" id="updateTodoId" placeholder="å¾…åŠäº‹é¡¹ID">
                <textarea id="updateTodoData" placeholder='{"title": "æ›´æ–°åçš„æ ‡é¢˜", "completed": true}' rows="3" cols="50"></textarea>
                <br><button class="test-btn" onclick="updateTodo()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method delete">DELETE</span>
                <strong>/api/todos/{id}</strong> - åˆ é™¤å¾…åŠäº‹é¡¹
                <br>
                <input type="text" id="deleteTodoId" placeholder="å¾…åŠäº‹é¡¹ID">
                <button class="test-btn" onclick="deleteTodo()">æµ‹è¯•</button>
            </div>
        </div>

        <!-- å®æ—¶åŒæ­¥API -->
        <div class="section">
            <h2 class="section-title">âš¡ å®æ—¶åŒæ­¥</h2>
            
            <div class="endpoint">
                <span class="method get">GET</span>
                <strong>/api/ws/stats</strong> - è·å–WebSocketè¿æ¥ç»Ÿè®¡
                <br><button class="test-btn" onclick="getWsStats()">æµ‹è¯•</button>
            </div>
            
            <div class="endpoint">
                <span class="method post">POST</span>
                <strong>/api/ws/broadcast</strong> - å¹¿æ’­æ¶ˆæ¯
                <br>
                <textarea id="broadcastData" placeholder='{"type": "test", "message": "æµ‹è¯•å¹¿æ’­æ¶ˆæ¯"}' rows="3" cols="50"></textarea>
                <br><button class="test-btn" onclick="broadcastMessage()">æµ‹è¯•</button>
            </div>
        </div>

        <!-- å“åº”ç»“æœæ˜¾ç¤º -->
        <div class="section">
            <h2 class="section-title">ğŸ“Š APIå“åº”ç»“æœ</h2>
            <div id="responseArea" class="response">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹APIå“åº”...</div>
            <button onclick="clearResponse()">æ¸…ç©ºç»“æœ</button>
        </div>
    </div>

    <script>
        let authToken = '';

        // æ˜¾ç¤ºå“åº”ç»“æœ
        function showResponse(data, isError = false) {
            const responseArea = document.getElementById('responseArea');
            const className = isError ? 'error' : 'success';
            responseArea.innerHTML = `<div class="${className}">${JSON.stringify(data, null, 2)}</div>`;
        }

        // æ¸…ç©ºå“åº”
        function clearResponse() {
            document.getElementById('responseArea').innerHTML = 'ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹APIå“åº”...';
        }

        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function callApi(url, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const options = {
                method: method,
                headers: headers
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`http://localhost:8001${url}`, options);
                
                // å¤„ç†ä¸åŒç±»å‹çš„å“åº”
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }
                
                if (response.ok) {
                    showResponse({status: response.status, data: result});
                    return result;
                } else {
                    showResponse({error: response.status, message: result.detail || result || 'è¯·æ±‚å¤±è´¥'}, true);
                    return null;
                }
            } catch (error) {
                showResponse({error: 'ç½‘ç»œé”™è¯¯', message: error.message}, true);
                return null;
            }
        }

        // ç™»å½•
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const result = await callApi('/api/auth/login', 'POST', {
                username: username,
                password: password
            });
            
            if (result && result.access_token) {
                authToken = result.access_token;
                document.getElementById('currentToken').textContent = authToken.substring(0, 30) + '...';
                showResponse({message: 'ç™»å½•æˆåŠŸ', token: authToken.substring(0, 20) + '...'});
            }
        }

        // æ³¨å†Œ
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const result = await callApi('/api/auth/register', 'POST', {
                username: username,
                password: password,
                email: `${username}@example.com`,
                full_name: username
            });
            
            if (result) {
                showResponse({message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•'});
            }
        }

        // è·å–å½“å‰ç”¨æˆ·
        async function getCurrentUser() {
            await callApi('/api/users/me');
        }

        // æ›´æ–°ç”¨æˆ·
        async function updateUser() {
            const userData = JSON.parse(document.getElementById('updateUserData').value);
            await callApi('/api/users/me', 'PUT', userData);
        }

        // è·å–å¾…åŠäº‹é¡¹åˆ—è¡¨
        async function getTodos() {
            const skip = document.getElementById('todoSkip').value || 0;
            const limit = document.getElementById('todoLimit').value || 100;
            await callApi(`/api/todos/?skip=${skip}&limit=${limit}`);
        }

        // åˆ›å»ºå¾…åŠäº‹é¡¹
        async function createTodo() {
            const todoData = JSON.parse(document.getElementById('createTodoData').value);
            await callApi('/api/todos/', 'POST', todoData);
        }

        // è·å–ç‰¹å®šå¾…åŠäº‹é¡¹
        async function getTodoById() {
            const id = document.getElementById('getTodoId').value;
            if (!id) {
                showResponse({error: 'è¯·è¾“å…¥å¾…åŠäº‹é¡¹ID'}, true);
                return;
            }
            await callApi(`/api/todos/${id}`);
        }

        // æ›´æ–°å¾…åŠäº‹é¡¹
        async function updateTodo() {
            const id = document.getElementById('updateTodoId').value;
            const todoData = JSON.parse(document.getElementById('updateTodoData').value);
            if (!id) {
                showResponse({error: 'è¯·è¾“å…¥å¾…åŠäº‹é¡¹ID'}, true);
                return;
            }
            await callApi(`/api/todos/${id}`, 'PUT', todoData);
        }

        // åˆ é™¤å¾…åŠäº‹é¡¹
        async function deleteTodo() {
            const id = document.getElementById('deleteTodoId').value;
            if (!id) {
                showResponse({error: 'è¯·è¾“å…¥å¾…åŠäº‹é¡¹ID'}, true);
                return;
            }
            await callApi(`/api/todos/${id}`, 'DELETE');
        }

        // è·å–WebSocketç»Ÿè®¡
        async function getWsStats() {
            await callApi('/api/ws/stats');
        }

        // å¹¿æ’­æ¶ˆæ¯
        async function broadcastMessage() {
            const broadcastData = JSON.parse(document.getElementById('broadcastData').value);
            await callApi('/api/ws/broadcast', 'POST', broadcastData);
        }

        // é¡µé¢åŠ è½½æç¤º
        document.addEventListener('DOMContentLoaded', function() {
            showResponse({message: 'APIæµ‹è¯•å·¥å…·å·²å°±ç»ªï¼Œè¯·å…ˆç™»å½•'});
        });
    </script>
</body>
</html>